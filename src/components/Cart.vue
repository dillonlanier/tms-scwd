<template>
  <v-dialog v-model='sync' persistent max-width='768'>
    <v-card>
      <v-form v-model='valid' ref='form'>
      <v-card-title class='headline pb-1'>
        Shopping Cart
        <v-spacer />
        <v-btn @click='close()' small icon><v-icon color='red'>close</v-icon></v-btn>
      </v-card-title>
      <v-divider />
      <v-card-text>
        <v-data-table dense :custom-sort='customSort' group-by='event.start' item-key='item.sku'
           hide-default-footer :items='items' :headers='headers' class='elevation-3'>
          <template v-slot:group.header="{group }">
            <strong class='ml-3'>{{ [group, 'YYYY-MM-DD H:mm'] | moment('MMM Do, YYYY [at] h:mm A') }}</strong>
          </template>
          <template v-slot:item.price="{ item }">
            {{ item.item.unit_amount.value | money }}
          </template>
          <template v-slot:item.quantity="{ item }">
              <v-select
                v-model='item.item.quantity'
                label='Quantity'
                style='width: 75px;'
                :items='Array(Math.min(item.event.avail - grouped.get(item.event.startTime) + Number(item.item.quantity), 30)).fill().map((_, idx) => String(1 + idx))' />
          </template>
          <template v-slot:item.subtotal="{ item }">
            <animated-number :value='item.item.quantity * item.item.unit_amount.value' :format='(val) => "$" + Number(val).toFixed(2)' />
          </template>
          <template v-slot:item.remove="{ item }">
            <v-btn small icon @click='removeFromCart(item.item.sku)'><v-icon>delete</v-icon></v-btn>
          </template>
          <template v-slot:footer>
            <v-divider />
            <!-- <span v-if="useGiftCard !== null" class="pl-3 pr-3 pb-2 success--text body-1">
              Gift Card Added! Current Balance: ${{ useGiftCard.balance }}
            </span> -->
            <v-text-field v-if="flags.allowGiftCards && useGiftCard == null"
              :error-messages='giftCardMessage !== "" ? giftCardMessage : undefined'
              :success="useGiftCard !== null"
              :readonly="useGiftCard !== null"
              v-model="giftInput"
              class="pl-3 pr-3 pb-2"
              persistent-hint
              type="text"
              counter="22"
              append-outer-icon="card_giftcard"
              @click:append-outer="validateGiftCard()"
              hint="Gift Card codes are case sensitive. Click the icon on the right to validate."
              label="Use Gift Card Code" />
            <v-divider />
            <div v-if="serviceFee > 0" class="d-flex flex-row-reverse">
              <p class="mr-2 mb-0">
                <strong class="pr-2">Subtotal:</strong>
                <animated-number :value="subtotal" :format='(val) => "$" + Number(val).toFixed(2)' />
              </p>
            </div>            
            <v-divider />
            <div v-if="serviceFee > 0" class='d-flex flex-row-reverse'>
              <p class='mr-2 mb-0'>
                <strong class="pr-2">Service Fee:</strong>
                <animated-number :value='serviceFee' :format='(val) => "$" + Number(val).toFixed(2)' />
              </p>
            </div>
            <v-divider v-if="useGiftCard !== null" />
            <div v-if="useGiftCard !== null" class="success--text d-flex flex-row-reverse">
              <p class="mr-2 mb-0">
                <strong class="pr-2">Gift Card:</strong>
                <animated-number :value="useGiftCard.balance" :format="(val) => '$' + Number(val).toFixed(2)" />
              </p>
            </div>
            <div class='d-flex flex-row-reverse'>
              <p class='mr-2 mb-0'>
                <strong class='pr-2'>Total:</strong>
                <animated-number :value='subtotal + serviceFee - ((useGiftCard !== null) ? useGiftCard.balance : 0)' :format='(val) => "$" + Number(val).toFixed(2)' />
              </p>
            </div>
          </template>
        </v-data-table>
        <v-row style='height: 50px'>
          <v-col style='height: 50px'>
            <span class='float-right ma-auto'>
              <v-dialog v-model='terms' width='600px'>
                <template v-slot:activator="{ on }">
                  <span class='mt-n1'>Purchasing tickets means you accept the <a v-on='on'>terms and conditions</a></span>
                </template>
                <v-card>
                  <v-card-title>
                    Terms and Conditions
                    <v-spacer />
                    <v-btn @click='terms = false' icon><v-icon color='red'>close</v-icon></v-btn>
                  </v-card-title>
                  <v-card-text v-html='config.terms' />
                </v-card>
              </v-dialog>
            </span>
          </v-col>
        </v-row>
      </v-card-text>
      <v-divider />
      <v-card-actions :class='flags.verticalPaypal ? "flex-column" : ""'>
        <p id='error-checkout' class='pr-2' v-if='errormsg.length > 0'>
          {{ errormsg }}
        </p>
        <p v-if='flags.verticalPaypal' class='subtitle-2'>Choose Your Payment Method</p>
          <v-spacer v-if='!flags.verticalPaypal' />
          <checkout-stripe v-if='flags.paymentHandler === "STRIPE"'
            @redeemed:success='redeemed()'
            :items='items.filter((i) => i.item.quantity > 0).map((i) => i.item)'
          />
          <paypal-checkout v-if='flags.paymentHandler === "PAYPAL"'
            class='checkout'
            :style='{"width": flags.verticalPaypal ? "50%" : undefined, "margin": flags.verticalPaypal ? "auto": undefined}'
            :key='btnrender'
            :items='fullItems'
            currency='USD'
            :amount='(subtotal + serviceFee).toFixed(2)'
            :context='appcontext'
            :payee='payee'
            description='Ticket Purchase'
            :btn-style='style'
            :onClick='clickcheck'
            :onError='errorHandler'
            :onInit='checkinit'
            :onDeclined='onDeclined'
            :giftCard='useGiftCard'
            @paypal-approved='approved($event)'
            @paypal-cancelled='$emit("checkout-cancelled", $event)'
            @paypal-completed='succeeded($event)'
          />
        <!-- <v-btn @click='emaildialog = true'>
          Checkout
        </v-btn> -->
      </v-card-actions>
      </v-form>
    </v-card>
    <v-dialog persistant v-model='paypalDecline' max-width='768'>
      <v-card>
        <v-card-title>ERRORED</v-card-title>
        <v-card-actions>
          <v-btn text>Close</v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
    <v-dialog persistent v-model='diag' max-width='768'>
      <v-card>
        <v-container>
          <v-row>
            <v-col cols='5'>
              <v-text-field label='email' />
            </v-col>
            <v-col offset='1' cols='5'>
              <v-text-field label='confirm' />
            </v-col>
          </v-row>
        </v-container>
        <v-card-actions>
          <v-btn @click='diag = false; prom(true)'>Success</v-btn>
          <v-spacer />
          <v-btn @click='diag = false; prom(false)'>Close</v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
    <v-dialog persistent v-model='emaildialog' max-width='768'>
      <v-card>
        <v-card-title class='headline pb-1'>
          Checkout
        </v-card-title>
        <v-card-text>

        </v-card-text>
        <v-card-actions>
          <v-spacer />
          <v-btn @click='emaildialog = false; btnrender += 1' text>
            Close
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-dialog>
</template>

<script lang='ts'>
import { Component, Vue, PropSync, Watch, Emit, Inject } from 'vue-property-decorator';
import { Getter, Mutation, Action } from 'vuex-class';
// import { CartItem } from '@/store/states';
import { Item } from '@/api/paypal';
import TicketCategory, { CartItem } from '@/api/tickets';
import PaypalCheckout, { ApproveActions } from '@/components/PayPalCheckout.vue';
import AnimatedNumber from '@/components/AnimatedNumber.vue';
import { EventInfo } from '@/api/product';
import { Config } from '@/api/config';
import CheckoutStripe from '@/components/stripe/StripeCheckout.vue';
import {
  BtnLayout, ShippingPreference, PreferedPayment, UserAction,
  BtnLabel, ClickData, ClickActions, ApproveData, OrderDetails, OrderError,
} from '@/api/paypal';
import { itemToGtag } from '../api/gtag';
import { CalFeatureFlags } from '../api/utils';

interface MerchantInfo {
  merchant_id: string;
  email_address: string;
}

function toNumList(arg: string | number[]): number[] {
  if (typeof arg === 'string') {
    return arg.split(',').map(Number);
  }

  return arg;
}

@Component({
  components: {
    PaypalCheckout,
    AnimatedNumber,
    CheckoutStripe,
  },
  filters: {
    capitalize: (value: string) => {
      if (!value) { return ''; }
      return value[0].toUpperCase() + value.slice(1);
    },
    money: (value: string | number) => {
      const val = Number(value);
      return '$' + val.toFixed(2);
    },
  },
})
export default class Cart extends Vue {
  @PropSync('show', {type: Boolean}) public sync!: boolean;
  @Getter('cart/items') public readonly items!: CartItem[];
  @Getter('tickets/categoryByName') public getPrices!: (name: string) => null | TicketCategory;
  @Mutation('cart/cleanCart') public cleanCart!: () => void;
  @Mutation('cart/removeFromCart') public removeFromCart!: (id: string) => void;
  @Mutation('cart/emptyCart') public emptyCart!: () => void;
  @Mutation('logError') public logErr!: (err: any) => void;
  @Getter('config') public readonly config!: Config;
  @Action('loadConfig') public loadConfig!: () => Promise<void>;
  @Action('tickets/validateGiftcard') public readonly validateCard!: 
    (id: string) => Promise<Response>;
  @Inject() public readonly flags!: CalFeatureFlags;

  public headers = [
    { text: 'Type', align: 'left', value: 'item.name', sortable: false},
    { text: 'Quantity', align: 'left', value: 'quantity', sortable: false},
    { text: 'Price Per Ticket', align: 'left', sortable: false, value: 'price'},
    { text: 'Sub Total', align: 'left', sortable: false, value: 'subtotal'},
    { text: 'Remove', value: 'remove', sortable: false },
  ];

  public valid = true;
  public errormsg = '';
  public terms = false;
  public emaildialog = false;
  public diag = false;
  public btnrender = 0;
  public prom: null | ((value?: boolean) => void) = null;
  public paypalDecline = false;
  public declineText = '';
  private giftInput = '';

  private useGiftCard: {id: string, initial: string, balance: number} | null = null;
  private giftCardMessage = '';

  public readonly appcontext = {
    shipping_preference: ShippingPreference.NO_SHIPPING,
    user_action: UserAction.PAY_NOW,
    payment_method: {
      payee_preferred: PreferedPayment.IMMEDIATE,
    },
  };

  public readonly useServiceFee = toNumList(process.env.VUE_APP_USE_SERVICE_FEE || '[]');

  public get payee(): MerchantInfo {
    return process.env.VUE_APP_PAYPAL_ENV === 'LIVE'
      ? this.live
      : this.sandbox;
  }

  public readonly style = {
    label: BtnLabel.BUYNOW,
    layout: this.flags.verticalPaypal ? BtnLayout.VERTICAL : BtnLayout.HORIZONTAL,
    tagline: false,
  };

  private readonly sandbox: MerchantInfo = {
    merchant_id: process.env.VUE_APP_SANDBOX_ID || '',
    email_address: process.env.VUE_APP_SANDBOX_EMAIL || '',
  };

  private readonly live: MerchantInfo = {
    merchant_id: process.env.VUE_APP_MERCHANT_ID || '',
    email_address: process.env.VUE_APP_MERCHANT_EMAIL || '',
  };

  public onDeclined(err: object, actions: ApproveActions): Promise<object> {
    return actions.restart();
  }

  public checkinit(data: object, actions: object) {
    // console.log(data, actions);
  }

  public mounted() {
    this.loadConfig();
  }

  @Emit('checkout-error')
  public errorHandler(err: OrderError) {
    if (err.name === 'UNPROCESSABLE_ENTITY') {
      if (err.details[0].issue === 'INSTRUMENT_DECLINED') {
        this.errormsg = 'Payment was declined, please try again with a different payment source.';
      } else {
        this.errormsg = 'PayPal was unable to process that payment, please try again or call PayPal for assistance';
      }
    } else {
      this.errormsg = 'Something Went Wrong, please try again.';
    }

    this.logErr(err);
  }

  public close() {
    this.sync = false;
    this.btnrender += 1;
    this.errormsg = '';
  }

  public async clickcheck(data: ClickData, actions: ClickActions) {
    if (this.items.length > 0) {
      this.$gtag.event('begin_checkout', {
        items: this.items.map((i, idx) => ({list_position: idx,  ...itemToGtag(i.item)})),
        coupon: '',
      });

      this.$gtag.event('set_checkout_option', {
        checkout_step: 1,
        checkout_option: 'funding_source',
        value: data.fundingSource === 'card' ? 1 : 0,
      });
      return actions.resolve();
    } else {
      this.errormsg = 'Must put stuff in your cart first';
      return actions.reject();
    }
  }

  public get grouped(): Map<string, number> {
    const ret = new Map<string, number>();
    for (const i of this.items) {
      let cur = ret.get(i.event.startTime);
      if (!cur) {
        cur = 0;
      }
      ret.set(i.event.startTime, cur + Number(i.item.quantity));
    }
    return ret;
  }

  public get fullItems(): Item[] {
    let itemlist = this.items.filter((i) => Number(i.item.quantity) > 0).map((i) => i.item);
    if (this.serviceFee > 0) {
      itemlist.push({
        name: "Service Fee",
        unit_amount: {currency_code: "USD", value: this.serviceFee.toFixed(2)},
        quantity: "1",
        sku: "SVCFEE",
      });
    }
    return itemlist;
  }

  public get serviceFee(): number {
    return this.items.filter((i) => this.useServiceFee.includes(i.event.boatId)).reduce((total, curr) => {
      return total + Number(curr.item.unit_amount.value) * Number(curr.item.quantity);
    }, 0) * 0.039;
  }

  public get subtotal(): number {
    return this.items.reduce((total, curr) => {
      return total + Number(curr.item.unit_amount.value) * Number(curr.item.quantity);
    }, 0);
  }

  public customSort(items: CartItem[], col: string, isDesc: boolean): CartItem[] {
    const factor = isDesc ? -1 : 1;
    return items.sort((a: CartItem, b: CartItem) => {
      if (a.item.sku < b.item.sku) {
        return 1 * factor;
      } else if (a.item.sku > b.item.sku) {
        return -1 * factor;
      } else {
        return 0;
      }
    });
  }

  public async validateGiftCard(): Promise<boolean> {
    const resp = await this.validateCard(this.giftInput);
    if (resp.ok) {
      const giftcard = await resp.json();
      if (giftcard.balance <= 0) {
        this.giftCardMessage = 'You have no balance on your giftcard left and thus cannot use it.';        
      } else if (giftcard.balance > this.subtotal) {
        this.giftCardMessage = 'Must use entire giftcard balance at one shot. Total must be greater than giftcard.';
      } else {
        this.useGiftCard = giftcard;
        return true;
      }
    } else {
      this.giftCardMessage = 'Gift Card Code not found!';
    }
    return false;
  }

  @Watch('show')
  public onShowChange(value: boolean, oldval: boolean) {
    if (oldval && !value) { this.cleanCart(); }
  }

  @Emit('paypal-approved')
  public approved(data: ApproveData) {
    this.$gtag.event('checkout_progress', {
      items: this.items.map((i, idx) => ({list_position: idx,  ...itemToGtag(i.item)})),
      coupon: '',
      checkout_step: 2,
    });
    this.sync = false;
  }

  @Emit('redeemed-success')
  public redeemed() {
    this.emptyCart();
  }

  @Emit('checkout-success')
  public succeeded(data: OrderDetails) {
    this.emptyCart();
  }
}
</script>

<style lang="stylus" scoped>
#error-checkout
  color red
  font-weight bold

// .checkout
  // width 50%
  // margin auto
</style>
